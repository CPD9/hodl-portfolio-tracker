import { NextRequest, NextResponse } from 'next/server';
import OpenAI from 'openai';

// Initialize OpenAI client
const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export async function POST(request: NextRequest) {
  try {
    const { messages } = await request.json();

    if (!messages || !Array.isArray(messages)) {
      return NextResponse.json(
        { error: 'Messages array is required' },
        { status: 400 }
      );
    }

    // Create a system message to give context about the HODL portfolio tracker
    const systemMessage = {
      role: 'system',
      content: `You are an AI assistant for HODL, an advanced portfolio tracking platform that supports both stocks and cryptocurrencies with Base blockchain integration. You help users with:

- Stock and crypto market analysis
- Portfolio management advice
- Trading insights and strategies
- Base blockchain and DeFi information
- General financial questions
- Platform navigation and features

Keep your responses helpful, concise, and focused on financial markets and portfolio management. If users ask about specific stocks or cryptocurrencies, provide informative analysis while noting that this is not financial advice.`
    };

    const completion = await openai.chat.completions.create({
      model: 'gpt-3.5-turbo',
      messages: [systemMessage, ...messages],
      max_tokens: 500,
      temperature: 0.7,
    });

    const assistantMessage = completion.choices[0]?.message;

    if (!assistantMessage) {
      return NextResponse.json(
        { error: 'No response from OpenAI' },
        { status: 500 }
      );
    }

    return NextResponse.json({ message: assistantMessage });
  } catch (error) {
    console.error('OpenAI API error:', error);
    return NextResponse.json(
      { error: 'Failed to process chat message' },
      { status: 500 }
    );
  }
}